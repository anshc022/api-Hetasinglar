name: Deploy to EC2

# Trigger workflow on push to main branch
on:
  push:
    branches: [ main ]
  workflow_dispatch: # Allow manual trigger

# Environment variables
env:
  PROJECT_PATH: /home/ec2-user/hetasinglar-api

jobs:
  deploy:
    name: Deploy Application
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout code
      - name: Checkout Repository
        uses: actions/checkout@v4
        
      # Step 2: Deploy to EC2 via SSH
      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: 22
          
          script: |
            echo "ğŸš€ Starting deployment process..."
            
            # Navigate to project directory
            cd ${{ env.PROJECT_PATH }}
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            git pull origin main
            
            # Stop existing containers
            echo "ğŸ›‘ Stopping existing containers..."
            docker compose down --remove-orphans || true
            
            # Remove old images to free up space
            echo "ğŸ§¹ Cleaning up old Docker images..."
            docker image prune -af || true
            
            # Build new image with latest code
            echo "ğŸ”¨ Building Docker image..."
            docker compose build --no-cache
            
            # Start containers in detached mode
            echo "â–¶ï¸ Starting containers..."
            docker compose up -d
            
            # Show container status
            echo "ğŸ“Š Container status:"
            docker compose ps
            
            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            docker compose logs --tail=20
            
            # Health check
            echo "ğŸ¥ Performing health check..."
            sleep 10
            if curl -f http://localhost:5000/api/health > /dev/null 2>&1; then
              echo "âœ… Deployment successful! Application is responding."
            else
              echo "âš ï¸ Warning: Health check failed. Check logs for issues."
              docker compose logs --tail=50
            fi
            
            echo "ğŸ‰ Deployment completed!"

      # Step 3: Deployment notification
      - name: Deployment Status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "ğŸš€ Deployment completed successfully!"
          else
            echo "âŒ Deployment failed. Check the logs above."
            exit 1
          fi